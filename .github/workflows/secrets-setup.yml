# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Kubernetes Secrets Setup Workflow
# Creates/updates the required secrets in Kubernetes
# Run this once to set up secrets, or when rotating keys
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: Setup Kubernetes Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
      action:
        description: 'Action to perform'
        required: true
        default: 'create'
        type: choice
        options:
          - create
          - delete
          - verify

jobs:
  secrets:
    name: Manage Secrets
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Setup Kubernetes
        uses: 2060-io/devops/actions/setup-kube@main
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}

      - name: Verify Secrets Exist in GitHub
        run: |
          echo "üîê Checking required GitHub secrets..."
          
          # These will fail if secrets don't exist
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "‚ö†Ô∏è  OPENAI_API_KEY not set in GitHub secrets"
          else
            echo "‚úÖ OPENAI_API_KEY is configured"
          fi
          
          if [ -z "${{ secrets.SERPAPI_KEY }}" ]; then
            echo "‚ö†Ô∏è  SERPAPI_KEY not set in GitHub secrets"
          else
            echo "‚úÖ SERPAPI_KEY is configured"
          fi
          
          if [ -z "${{ secrets.OPENWEATHER_API_KEY }}" ]; then
            echo "‚ö†Ô∏è  OPENWEATHER_API_KEY not set in GitHub secrets"
          else
            echo "‚úÖ OPENWEATHER_API_KEY is configured"
          fi

      - name: Create Kubernetes Secret
        if: inputs.action == 'create'
        run: |
          NAMESPACE="demos"
          SECRET_NAME="concieragent-api-keys"
          
          echo "üîê Creating Kubernetes secret: $SECRET_NAME"
          
          # Delete existing secret if it exists
          kubectl delete secret $SECRET_NAME -n $NAMESPACE --ignore-not-found
          
          # Create new secret
          kubectl create secret generic $SECRET_NAME \
            --namespace $NAMESPACE \
            --from-literal=OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            --from-literal=ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
            --from-literal=SERPAPI_KEY="${{ secrets.SERPAPI_KEY }}" \
            --from-literal=OPENWEATHER_API_KEY="${{ secrets.OPENWEATHER_API_KEY }}"
          
          echo "‚úÖ Secret created successfully"

      - name: Delete Kubernetes Secret
        if: inputs.action == 'delete'
        run: |
          NAMESPACE="demos"
          SECRET_NAME="concieragent-api-keys"
          
          echo "üóëÔ∏è Deleting Kubernetes secret: $SECRET_NAME"
          kubectl delete secret $SECRET_NAME -n $NAMESPACE --ignore-not-found
          echo "‚úÖ Secret deleted"

      - name: Verify Kubernetes Secret
        if: inputs.action == 'verify'
        run: |
          NAMESPACE="demos"
          SECRET_NAME="concieragent-api-keys"
          
          echo "üîç Verifying Kubernetes secret: $SECRET_NAME"
          
          if kubectl get secret $SECRET_NAME -n $NAMESPACE > /dev/null 2>&1; then
            echo "‚úÖ Secret exists"
            echo ""
            echo "Secret keys:"
            kubectl get secret $SECRET_NAME -n $NAMESPACE -o jsonpath='{.data}' | jq 'keys'
          else
            echo "‚ùå Secret does not exist"
            exit 1
          fi
